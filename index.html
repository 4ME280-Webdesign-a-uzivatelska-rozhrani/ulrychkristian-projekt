<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cestovatelsk√Ω den√≠k s mapou, √∫pravy a maz√°n√≠m</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 1rem; background-color: #f9f9f9; }
    .destination, .new-location { background: #fff; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    img { max-width: 100%; border-radius: 8px; margin: 0.5rem 0; cursor: pointer; }
    textarea, input, select { width: 100%; margin: 0.3rem 0; padding: 0.4rem; }
    button { margin-top: 0.5rem; padding: 0.5rem 1rem; border: none; background-color: #0077cc; color: white; border-radius: 4px; cursor: pointer; }
    #map { height: 400px; margin: 1rem 0; border-radius: 8px; }
    .planned { opacity: 0.6; }
    .section { margin-bottom: 2rem; }
    .section h2 { border-bottom: 2px solid #ccc; padding-bottom: 0.3rem; }
    #imageModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
    #imageModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
    #imageModal span { position: absolute; top: 20px; right: 40px; font-size: 40px; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Cestovatelsk√Ω den√≠k</h1>
  <div id="map"></div>

  <div class="new-location">
    <h2>‚ûï Nov√° lokalita</h2>
    <input type="text" id="new-mesto" placeholder="Mƒõsto" required />
    <input type="date" id="new-datum" required />
    <input type="text" id="new-lokace" placeholder="Nav≈°t√≠ven√° m√≠sta" required />
    <textarea id="new-popis" placeholder="Popis cesty" required></textarea>
    <input type="url" id="new-obrazek" placeholder="URL obr√°zku" required />
    <textarea id="new-zaznam" placeholder="Z√°pis/koment√°≈ô (nepovinn√©)"></textarea>
    <label><input type="checkbox" id="new-navstiveno"> Nav≈°t√≠veno</label>
    <button onclick="pridatNovouLokaci()">üíæ P≈ôidat lokaci</button>
  </div>

  <div>
    <label for="rok-filter"><strong>Filtrovat podle roku:</strong></label>
    <select id="rok-filter" onchange="zobrazDenik()">
      <option value="">V≈°echny roky</option>
    </select>

    <label for="search-filter"><strong>Vyhledat:</strong></label>
    <input type="text" id="search-filter" placeholder="Hledat v mƒõstƒõ, popisu nebo pozn√°mce" oninput="zobrazDenik()" />

    <label for="sort-filter"><strong>Se≈ôadit podle:</strong></label>
    <select id="sort-filter" onchange="zobrazDenik()">
      <option value="novy">Od nejnovƒõj≈°√≠ch</option>
      <option value="stary">Od nejstar≈°√≠ch</option>
      <option value="abeceda">Abecednƒõ</option>
    </select>
  </div>

  <div class="section">
    <h2>‚úÖ Nav≈°t√≠ven√© lokace</h2>
    <div id="visited"></div>
  </div>

  <div class="section">
    <h2>üìç Pl√°novan√© lokace</h2>
    <div id="planned"></div>
  </div>

  <div id="imageModal" onclick="this.style.display='none'">
    <span onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <img id="modalImage" src="" alt="Zvƒõt≈°en√Ω obr√°zek" />
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const BIN_ID = "6836e9068960c979a5a21f76";
    const MASTER_KEY = "$2a$10$6.w3P.QfhbFQnbnWjZrsg.wsBOO9azO3iyMntL.YxupxTXtjFchvy";
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
    let entries = [];

    const map = L.map('map').setView([48.8566, 2.3522], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap',
      maxZoom: 18
    }).addTo(map);

    function zobrazDenik() {
      const visitedContainer = document.getElementById("visited");
      const plannedContainer = document.getElementById("planned");
      const selectedYear = document.getElementById("rok-filter").value;
      const searchQuery = document.getElementById("search-filter")?.value?.toLowerCase() || "";
      const sortOption = document.getElementById("sort-filter")?.value || "novy";

      visitedContainer.innerHTML = "";
      plannedContainer.innerHTML = "";
      map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });

      let filtered = entries.filter(entry => {
        const entryYear = entry.datum?.substring(0, 4);
        if (selectedYear && selectedYear !== entryYear) return false;
        if (
          searchQuery &&
          ![entry.mesto, entry.popis, entry.zaznam].some(field => field?.toLowerCase().includes(searchQuery))
        ) return false;
        return true;
      });

      filtered.sort((a, b) => {
        if (sortOption === "novy") return new Date(b.datum) - new Date(a.datum);
        if (sortOption === "stary") return new Date(a.datum) - new Date(b.datum);
        if (sortOption === "abeceda") return a.mesto.localeCompare(b.mesto);
        return 0;
      });

      filtered.forEach((entry, index) => {
        const div = document.createElement("div");
        div.className = "destination" + (!entry.navstiveno ? " planned" : "");

        if (entry.editing) {
          div.innerHTML = `
            <input type="text" value="${entry.mesto}" onchange="entries[${index}].mesto = this.value" />
            <input type="date" value="${entry.datum}" onchange="entries[${index}].datum = this.value" />
            <input type="text" value="${entry.lokace}" onchange="entries[${index}].lokace = this.value" />
            <textarea onchange="entries[${index}].popis = this.value">${entry.popis}</textarea>
            <input type="url" value="${entry.obrazek}" onchange="entries[${index}].obrazek = this.value" />
            <textarea onchange="entries[${index}].zaznam = this.value">${entry.zaznam || ""}</textarea>
            <label><input type="checkbox" ${entry.navstiveno ? 'checked' : ''} onchange="entries[${index}].navstiveno = this.checked"> Nav≈°t√≠veno</label>
            <button onclick="ulozitZmenu(${index})">üíæ Ulo≈æit zmƒõny</button>
            <button onclick="zrusitEditaci(${index})">Zru≈°it</button>
          `;
        } else {
          div.innerHTML = `
            <h2>${entry.mesto} ${entry.navstiveno ? '[NAV≈†T√çVENO]' : '[PL√ÅNUJI]'}</h2>
            <p><strong>Datum:</strong> ${entry.datum}</p>
            <p><strong>M√≠sta:</strong> ${entry.lokace}</p>
            <p><strong>Popis:</strong> ${entry.popis}</p>
            <img src="${entry.obrazek}" alt="${entry.mesto}" onclick="zobrazObrazek('${entry.obrazek}')" />
            <p><strong>Z√°znam:</strong> ${entry.zaznam || "---"}</p>
            <button onclick="editovat(${index})">‚úèÔ∏è Upravit</button>
            <button onclick="smazat(${index})">üóëÔ∏è Smazat</button>
          `;
          if (entry.lat && entry.lng) {
            L.marker([entry.lat, entry.lng]).addTo(map)
              .bindPopup(`<strong>${entry.mesto}</strong><br>${entry.lokace}`);
          }
        }

        (entry.navstiveno ? visitedContainer : plannedContainer).appendChild(div);
      });
    }

    function zobrazObrazek(src) {
      document.getElementById("modalImage").src = src;
      document.getElementById("imageModal").style.display = "flex";
    }

    function naplnitRoky() {
      const select = document.getElementById("rok-filter");
      const roky = [...new Set(entries.map(e => e.datum?.substring(0, 4)).filter(Boolean))].sort();
      roky.forEach(rok => {
        const opt = document.createElement("option");
        opt.value = rok;
        opt.textContent = rok;
        select.appendChild(opt);
      });
    }

    function ulozitZmenu(index) {
      entries[index].editing = false;
      ulozDoBin();
    }

    function zrusitEditaci(index) {
      entries[index].editing = false;
      zobrazDenik();
    }

    function editovat(index) {
      entries[index].editing = true;
      zobrazDenik();
    }

    function smazat(index) {
      if (confirm("Opravdu chcete smazat tuto lokaci?")) {
        entries.splice(index, 1);
        ulozDoBin();
      }
    }

    function ulozDoBin() {
      fetch(API_URL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": MASTER_KEY
        },
        body: JSON.stringify(entries)
      }).then(() => {
        zobrazDenik();
      }).catch(err => alert("Chyba p≈ôi ukl√°d√°n√≠."));
    }

    function pridatNovouLokaci() {
      const mesto = document.getElementById("new-mesto").value;
      const datum = document.getElementById("new-datum").value;
      const lokace = document.getElementById("new-lokace").value;
      const popis = document.getElementById("new-popis").value;
      const obrazek = document.getElementById("new-obrazek").value;
      const zaznam = document.getElementById("new-zaznam").value;
      const navstiveno = document.getElementById("new-navstiveno").checked;

      if (!mesto || !datum || !lokace || !popis || !obrazek) {
        alert("Vypl≈à v≈°echna povinn√° pole.");
        return;
      }

      const query = encodeURIComponent(mesto);
      fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json`)
        .then(res => res.json())
        .then(results => {
          if (!results.length) {
            alert("M√≠sto nenalezeno.");
            return;
          }

          const { lat, lon } = results[0];
          const nova = { mesto, datum, lokace, popis, obrazek, zaznam, navstiveno, lat: parseFloat(lat), lng: parseFloat(lon) };
          entries.push(nova);
          ulozDoBin();
        })
        .catch(err => {
          console.error(err);
          alert("Chyba p≈ôi geok√≥dov√°n√≠.");
        });
    }

    fetch(API_URL, { headers: { "X-Master-Key": MASTER_KEY } })
      .then(res => res.json())
      .then(data => {
        entries = data.record.map(e => ({ ...e, editing: false }));
        naplnitRoky();
        zobrazDenik();
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>
